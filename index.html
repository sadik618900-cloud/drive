<!DOCTYPE html>
<html>
<head>
  <title>Sadik Cloud</title>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <script src="https://apis.google.com/js/api.js"></script>

  <style>
    body { font-family: Arial; text-align:center; background:#f5f7fb; }
    h2 { margin-top:20px; }

    #dropZone {
      border:2px dashed #007bff;
      padding:30px;
      margin:20px auto;
      width:400px;
      border-radius:10px;
      background:#fff;
    }

    #dropZone.hover {
      background:#e3f0ff;
    }

    button {
      padding:8px 15px;
      margin:5px;
      border:none;
      background:#007bff;
      color:white;
      border-radius:5px;
      cursor:pointer;
    }

    progress {
      width:400px;
      height:20px;
    }

    table {
      margin:20px auto;
      border-collapse:collapse;
      width:80%;
      background:white;
    }

    th, td {
      border:1px solid #ddd;
      padding:8px;
    }

    th {
      background:#007bff;
      color:white;
    }
  </style>
</head>

<body>

<h2>Sadik Cloud Storage</h2>

<div id="loginDiv"></div>

<div id="uploadArea" style="display:none;">
  <div id="dropZone">
    <p>Drag & Drop files here</p>
    <p>or</p>
    <input type="file" id="fileInput" multiple hidden>
    <button onclick="document.getElementById('fileInput').click()">Select Files</button>
  </div>

  <br>
  <progress id="progressBar" value="0" max="100" style="display:none;"></progress>
</div>

<table id="fileTable">
  <thead>
    <tr>
      <th>Name</th>
      <th>Size</th>
      <th>Action</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<script>

const CLIENT_ID = "616933700070-sgh79m0pe5gskbfsg57ok4fvedmg2dev.apps.googleusercontent.com";
const ADMIN_EMAIL = "sadik618900@gmail.com";
const PUBLIC_FOLDER_ID = "1KHCBi0YJlQJOGS4V9P-pHnHHLpNrv_Y0";

let accessToken;
let userEmail;

google.accounts.id.initialize({
  client_id: CLIENT_ID,
  callback: handleCredentialResponse
});

google.accounts.id.renderButton(
  document.getElementById("loginDiv"),
  { theme: "outline", size: "large" }
);

function handleCredentialResponse(response) {
  const decoded = JSON.parse(atob(response.credential.split('.')[1]));
  userEmail = decoded.email;

  gapi.load('client', async () => {
    await gapi.client.init({
      discoveryDocs: ["https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"]
    });

    const tokenClient = google.accounts.oauth2.initTokenClient({
      client_id: CLIENT_ID,
      scope: 'https://www.googleapis.com/auth/drive',
      callback: (tokenResponse) => {
        accessToken = tokenResponse.access_token;
        listFiles();

        if (userEmail === ADMIN_EMAIL) {
          document.getElementById("uploadArea").style.display = "block";
        }
      }
    });

    tokenClient.requestAccessToken();
  });
}

async function listFiles() {
  const res = await gapi.client.drive.files.list({
    q: `'${PUBLIC_FOLDER_ID}' in parents and trashed=false`,
    fields: "files(id,name,size)"
  });

  const tbody = document.querySelector("#fileTable tbody");
  tbody.innerHTML = "";

  res.result.files.forEach(file => {
    const sizeKB = file.size ? (file.size/1024).toFixed(2)+" KB" : "â€”";

    tbody.innerHTML += `
      <tr>
        <td>${file.name}</td>
        <td>${sizeKB}</td>
        <td>
          <a href="https://drive.google.com/uc?id=${file.id}&export=download" target="_blank">
            <button>Download</button>
          </a>
        </td>
      </tr>
    `;
  });
}

const dropZone = document.getElementById("dropZone");
const fileInput = document.getElementById("fileInput");
const progressBar = document.getElementById("progressBar");

dropZone.addEventListener("dragover", e => {
  e.preventDefault();
  dropZone.classList.add("hover");
});

dropZone.addEventListener("dragleave", () => {
  dropZone.classList.remove("hover");
});

dropZone.addEventListener("drop", e => {
  e.preventDefault();
  dropZone.classList.remove("hover");
  uploadFiles(e.dataTransfer.files);
});

fileInput.addEventListener("change", () => {
  uploadFiles(fileInput.files);
});

function uploadFiles(files) {
  Array.from(files).forEach(file => uploadFile(file));
}

function uploadFile(file) {

  progressBar.style.display = "block";
  progressBar.value = 0;

  const metadata = {
    name: file.name,
    parents: [PUBLIC_FOLDER_ID]
  };

  const form = new FormData();
  form.append("metadata", new Blob([JSON.stringify(metadata)], {type: "application/json"}));
  form.append("file", file);

  const xhr = new XMLHttpRequest();
  xhr.open("POST", "https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart");
  xhr.setRequestHeader("Authorization", "Bearer " + accessToken);

  xhr.upload.onprogress = function(event) {
    if (event.lengthComputable) {
      progressBar.value = (event.loaded / event.total) * 100;
    }
  };

  xhr.onload = function() {
    progressBar.value = 100;
    setTimeout(()=>progressBar.style.display="none",1000);
    listFiles();
  };

  xhr.send(form);
}

</script>

</body>
</html>
