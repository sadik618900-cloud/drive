<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Drive Cloud Dashboard</title>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <script src="https://apis.google.com/js/api.js"></script>
  <style>
    body { font-family: Arial; padding: 20px; }
    button { padding: 8px 12px; margin: 5px; }
    .file { margin: 8px 0; }
  </style>
</head>
<body>

<h2>Drive Cloud Dashboard</h2>

<div id="loginDiv"></div>
<button id="logoutBtn" style="display:none;">Logout</button>
<br><br>

<input type="file" id="fileInput" style="display:none;" />
<button id="uploadBtn" style="display:none;">Upload File</button>

<h3>Files:</h3>
<div id="fileList"></div>

<script>

const CLIENT_ID = "616933700070-sgh79m0pe5gskbfsg57ok4fvedmg2dev.apps.googleusercontent.com";
const DISCOVERY_DOC = "https://www.googleapis.com/discovery/v1/apis/drive/v3/rest";
const SCOPES = "https://www.googleapis.com/auth/drive.file https://www.googleapis.com/auth/drive.metadata.readonly";

const ADMIN_EMAIL = "sadik618900@gmail.com"; // তোমার Gmail

let accessToken = null;
let userEmail = null;

async function initializeGapi() {
  await gapi.client.init({
    discoveryDocs: [DISCOVERY_DOC],
  });
}

function loadGapi() {
  gapi.load('client', initializeGapi);
}

function handleCredentialResponse(response) {
  const decoded = parseJwt(response.credential);
  userEmail = decoded.email;

  if (userEmail === ADMIN_EMAIL) {
    document.getElementById("uploadBtn").style.display = "inline-block";
    document.getElementById("fileInput").style.display = "inline-block";
  }

  document.getElementById("logoutBtn").style.display = "inline-block";
  document.getElementById("loginDiv").style.display = "none";

  listFiles();
}

function parseJwt (token) {
  var base64Url = token.split('.')[1];
  var base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
  var jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
      return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
  }).join(''));

  return JSON.parse(jsonPayload);
}

async function listFiles() {
  const response = await fetch(
    "https://www.googleapis.com/drive/v3/files?pageSize=20&fields=files(id,name)",
    {
      headers: { Authorization: `Bearer ${responseToken()}` }
    }
  );

  const data = await response.json();
  const fileList = document.getElementById("fileList");
  fileList.innerHTML = "";

  if (!data.files || data.files.length === 0) {
    fileList.innerHTML = "No files found.";
    return;
  }

  data.files.forEach(file => {
    const div = document.createElement("div");
    div.className = "file";
    div.innerHTML = `<a href="https://drive.google.com/file/d/${file.id}/view" target="_blank">${file.name}</a>`;
    fileList.appendChild(div);
  });
}

function responseToken() {
  return google.accounts.id._instance.tokenClient.access_token;
}

document.getElementById("uploadBtn").onclick = async () => {
  const file = document.getElementById("fileInput").files[0];
  if (!file) return alert("Select a file first");

  const metadata = {
    name: file.name
  };

  const form = new FormData();
  form.append("metadata", new Blob([JSON.stringify(metadata)], {type: "application/json"}));
  form.append("file", file);

  await fetch("https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart", {
    method: "POST",
    headers: {
      Authorization: `Bearer ${responseToken()}`
    },
    body: form
  });

  alert("Uploaded Successfully!");
  listFiles();
};

document.getElementById("logoutBtn").onclick = () => {
  location.reload();
};

window.onload = () => {
  loadGapi();
  google.accounts.id.initialize({
    client_id: CLIENT_ID,
    callback: handleCredentialResponse
  });

  google.accounts.id.renderButton(
    document.getElementById("loginDiv"),
    { theme: "outline", size: "large" }
  );
};

</script>

</body>
</html>
