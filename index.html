<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Sadik Cloud</title>
<script src="https://accounts.google.com/gsi/client" async defer></script>
<style>
body { font-family: Arial; background:#f4f6f9; padding:20px; }
h2 { text-align:center; }
.topbar { text-align:center; margin-bottom:20px; }
button { padding:8px 14px; margin:5px; cursor:pointer; }
input[type="text"] { padding:8px; width:250px; }
.grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(200px,1fr)); gap:15px; }
.card {
  background:white;
  padding:15px;
  border-radius:10px;
  box-shadow:0 2px 6px rgba(0,0,0,0.1);
}
.card h4 { margin:0 0 10px 0; word-break:break-word; }
.card a { text-decoration:none; color:#007bff; }
.admin { margin-top:10px; }
</style>
</head>
<body>

<h2>‚òÅ Sadik Cloud Storage</h2>

<div class="topbar">
  <div id="loginDiv"></div>
  <button id="logoutBtn" style="display:none;">Logout</button>
  <br><br>
  <input type="text" id="searchBox" placeholder="Search file..." onkeyup="filterFiles()">
  <br><br>
  <input type="file" id="fileInput" style="display:none;">
  <button id="uploadBtn" style="display:none;">Upload</button>
</div>

<div class="grid" id="fileList"></div>

<script>

const CLIENT_ID = "616933700070-sgh79m0pe5gskbfsg57ok4fvedmg2dev.apps.googleusercontent.com";
const ADMIN_EMAIL = "sadik618900@gmail.com";
const PUBLIC_FOLDER_ID = "1KHCBi0YJlQJOGS4V9P-pHnHHLpNrv_Y0";

let accessToken = null;
let userEmail = null;
let allFiles = [];

function handleCredentialResponse(response) {
  const decoded = JSON.parse(atob(response.credential.split('.')[1]));
  userEmail = decoded.email;
  accessToken = response.credential;

  if (userEmail === ADMIN_EMAIL) {
    document.getElementById("uploadBtn").style.display = "inline-block";
    document.getElementById("fileInput").style.display = "inline-block";
  }

  document.getElementById("logoutBtn").style.display = "inline-block";
  document.getElementById("loginDiv").style.display = "none";

  listFiles();
}

async function listFiles() {
  const res = await fetch(
    `https://www.googleapis.com/drive/v3/files?q='${PUBLIC_FOLDER_ID}'+in+parents&fields=files(id,name,mimeType)`,
    { headers: { Authorization: `Bearer ${accessToken}` } }
  );

  const data = await res.json();
  allFiles = data.files || [];
  renderFiles(allFiles);
}

function renderFiles(files) {
  const container = document.getElementById("fileList");
  container.innerHTML = "";

  if (files.length === 0) {
    container.innerHTML = "<p>No files found.</p>";
    return;
  }

  files.forEach(file => {
    const div = document.createElement("div");
    div.className = "card";

    div.innerHTML = `
      <h4>${file.name}</h4>
      <a href="https://drive.google.com/file/d/${file.id}/view" target="_blank">Download</a>
      ${userEmail === ADMIN_EMAIL ? `
      <div class="admin">
        <button onclick="deleteFile('${file.id}')">Delete</button>
      </div>` : ``}
    `;

    container.appendChild(div);
  });
}

function filterFiles() {
  const keyword = document.getElementById("searchBox").value.toLowerCase();
  const filtered = allFiles.filter(file =>
    file.name.toLowerCase().includes(keyword)
  );
  renderFiles(filtered);
}

document.getElementById("uploadBtn").onclick = async () => {
  const file = document.getElementById("fileInput").files[0];
  if (!file) return alert("Select a file first");

  const metadata = {
    name: file.name,
    parents: [PUBLIC_FOLDER_ID]
  };

  const form = new FormData();
  form.append("metadata", new Blob([JSON.stringify(metadata)], { type: "application/json" }));
  form.append("file", file);

  await fetch("https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart", {
    method: "POST",
    headers: { Authorization: `Bearer ${accessToken}` },
    body: form
  });

  alert("Uploaded Successfully!");
  listFiles();
};

async function deleteFile(fileId) {
  if (!confirm("Delete this file?")) return;

  await fetch(`https://www.googleapis.com/drive/v3/files/${fileId}`, {
    method: "DELETE",
    headers: { Authorization: `Bearer ${accessToken}` }
  });

  alert("Deleted!");
  listFiles();
}

document.getElementById("logoutBtn").onclick = () => location.reload();

window.onload = () => {
  google.accounts.id.initialize({
    client_id: CLIENT_ID,
    callback: handleCredentialResponse
  });

  google.accounts.id.renderButton(
    document.getElementById("loginDiv"),
    { theme: "outline", size: "large" }
  );
};

</script>

</body>
</html>
