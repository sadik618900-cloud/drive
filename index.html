<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Drive Cloud Dashboard</title>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <script src="https://apis.google.com/js/api.js"></script>
  <style>
    body { font-family: Arial, padding: 20px; }
    button { padding: 8px 12px; margin: 5px; }
    .file { margin: 8px 0; }
  </style>
</head>
<body>

  <h2>Drive Cloud Dashboard</h2>

  <div id="loginDiv"></div>
  <button id="logoutBtn" style="display:none;">Logout</button>

  <br><br>

  <input type="file" id="fileInput" style="display:none;" />
  <button id="uploadBtn" style="display:none;">Upload File</button>

  <h3>Files:</h3>
  <div id="fileList"></div>

  <script>

    const CLIENT_ID = "616933700070-sgh79m0pe5gskbfsg57ok4fvedmg2dev.apps.googleusercontent.com";
    const DISCOVERY_DOC = "https://www.googleapis.com/discovery/v1/apis/drive/v3/rest";
    const SCOPES = "https://www.googleapis.com/auth/drive.file";
    const ADMIN_EMAIL = "sadik618900@gmail.com";
    const PUBLIC_FOLDER_ID = "1KHCBi0YJlQJOGS4V9P-pHnHHLpNrv_Y0";

    let tokenClient;
    let accessToken;
    let userEmail;

    function initializeGapi() {
      gapi.load('client', async () => {
        await gapi.client.init({ discoveryDocs: [DISCOVERY_DOC] });
      });
    }

    function handleCredentialResponse(response) {
      const decoded = JSON.parse(atob(response.credential.split('.')[1]));
      userEmail = decoded.email;
      accessToken = response.credential;

      if (userEmail === ADMIN_EMAIL) {
        document.getElementById("uploadBtn").style.display = "inline-block";
        document.getElementById("fileInput").style.display = "inline-block";
      }

      document.getElementById("logoutBtn").style.display = "inline-block";
      document.getElementById("loginDiv").style.display = "none";

      listPublicFiles();
    }

    async function listPublicFiles() {
      const url = `https://www.googleapis.com/drive/v3/files?q='${PUBLIC_FOLDER_ID}'+in+parents&fields=files(id,name)`;
      const res = await fetch(url, {
        headers: { Authorization: `Bearer ${accessToken}` }
      });
      const data = await res.json();

      const fileList = document.getElementById("fileList");
      fileList.innerHTML = "";

      if (!data.files || data.files.length === 0) {
        fileList.innerHTML = "No files found.";
        return;
      }

      data.files.forEach(file => {
        const div = document.createElement("div");
        div.className = "file";
        div.innerHTML = `
          <a href="https://drive.google.com/file/d/${file.id}/view" target="_blank">
            ${file.name}
          </a>
        `;
        fileList.appendChild(div);
      });
    }

    document.getElementById("uploadBtn").onclick = async () => {
      const file = document.getElementById("fileInput").files[0];
      if (!file) return alert("Select a file first");

      const metadata = {
        name: file.name,
        parents: [PUBLIC_FOLDER_ID]
      };

      const form = new FormData();
      form.append("metadata", new Blob([JSON.stringify(metadata)], { type: "application/json" }));
      form.append("file", file);

      await fetch("https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart", {
        method: "POST",
        headers: { Authorization: `Bearer ${accessToken}` },
        body: form
      });

      alert("Uploaded Successfully!");
      listPublicFiles();
    };

    document.getElementById("logoutBtn").onclick = () => {
      location.reload();
    };

    window.onload = () => {
      initializeGapi();
      google.accounts.id.initialize({
        client_id: CLIENT_ID,
        callback: handleCredentialResponse
      });

      google.accounts.id.renderButton(
        document.getElementById("loginDiv"),
        { theme: "outline", size: "large" }
      );

      // Always list public files (even before login)
      listPublicFiles();
    };

  </script>
</body>
</html>
